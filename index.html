<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MyNameis</title>
  <style>
    :root{ --card-w:360px }
    *{ box-sizing:border-box }
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", system-ui, sans-serif;
      background:url("https://images.unsplash.com/photo-1520975922284-9e0ce8275f5b?q=80&w=1600&auto=format&fit=crop") center/cover fixed;
      position:relative;
    }
    body::before{ content:""; position:absolute; inset:0; background:rgba(255,255,255,.35); z-index:0 }
    #content,#loading{ position:relative; z-index:1 }

    /* loading */
    #loading{
      position:fixed; inset:0; display:flex; flex-direction:column; gap:10px;
      justify-content:center; align-items:center; background:rgba(239,244,255,.9);
      color:#000; font-weight:700; z-index:1000;
    }
    .dot{ display:flex; gap:8px; margin-bottom:6px }
    .dot i{ width:12px; height:12px; background:#5865F2; border-radius:50%;
      animation:jump .6s infinite alternate ease-in-out }
    .dot i:nth-child(2){ animation-delay:.2s } .dot i:nth-child(3){ animation-delay:.4s }
    @keyframes jump{ from{transform:translateY(0)} to{transform:translateY(-10px)} }

    /* card */
    #content{
      display:none; width:var(--card-w); border-radius:16px; overflow:hidden; background:#fff;
      box-shadow:0 8px 24px rgba(0,0,0,.25); animation:fadeIn 1s ease;
    }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
    .top{
      background:
        linear-gradient(135deg, rgba(127,90,240,.2), rgba(255,128,191,.2)),
        url("https://images.unsplash.com/photo-1549880338-65ddcdfd017b?q=80&w=1600&auto=format&fit=crop") center/cover;
      padding:60px 20px 80px; text-align:center; color:#fff; position:relative;
    }
    .top img{
      width:110px; height:110px; border-radius:50%; border:4px solid #fff; object-fit:cover;
      box-shadow:0 4px 12px rgba(0,0,0,.3); position:absolute; bottom:-55px; left:50%;
      transform:translateX(-50%); background:#fff;
    }
    .bottom{ padding:70px 24px 30px; text-align:center }
    h1{ margin:-4px 0 10px; font-size:24px; font-weight:800; color:#111 }
    .tags{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:14px }
    .tag{
      padding:6px 14px; border-radius:20px; font-size:12px; font-weight:800; color:#fff;
      background:#fd8a8a; box-shadow:0 8px 18px #fd8a8a; transition:transform .2s ease;
    }
    .btns{ display:flex; flex-direction:column; gap:12px }
    .btn{
      display:block; padding:12px 0; text-decoration:none; background:#f8fafc; color:#111827; font-weight:800;
      border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.1)
    }

    /* fab & panel */
    .fab{ position:fixed; right:14px; bottom:14px; display:flex; gap:8px; z-index:1200 }
    .fab button{ width:48px; height:48px; border-radius:50%; border:none; color:#fff; background:#111; font-size:20px }
    .auth{ background:#4b5563 }

    .panel{ position:fixed; left:0; right:0; bottom:0; max-height:85vh; background:#fff; border-radius:16px 16px 0 0;
      box-shadow:0 -12px 32px rgba(0,0,0,.18); transform:translateY(100%); transition:.3s ease; z-index:1100 }
    .panel.open{ transform:translateY(0) }
    .ph{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eee; position:sticky; top:0; background:#fff }
    .pb{ padding:12px 14px; overflow:auto; max-height:calc(85vh - 50px) }
    .row{ display:grid; grid-template-columns:1fr; gap:8px; margin-bottom:10px }
    .row-2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px }
    label{ font-size:12px; font-weight:700 }
    input[type="text"],input[type="url"],input[type="email"],input[type="password"]{
      width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px
    }
    .list{ display:flex; flex-direction:column; gap:8px }
    .item{ border:1px solid #eef0f3; border-radius:10px; padding:10px }
    .small{ padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; font-weight:700; font-size:12px }
    .primary{ background:#111; color:#fff; border-color:#111 }
    .danger{ background:#fee2e2; color:#991b1b; border-color:#fecaca }
    .note{ font-size:12px; color:#6b7280 }
    .color{ width:100%; height:40px; border:none; margin-top:6px }

    /* modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:1300 }
    .modal.open{ display:flex }
    .mc{ width:min(480px,92vw); background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 28px rgba(0,0,0,.25) }
    .mh{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }

    .actions{ display:flex; gap:6px }
    .share{ display:flex; gap:6px; flex-wrap:wrap }
  </style>
</head>
<body>
  <!-- Loading -->
  <div id="loading" role="status" aria-live="polite">
    <div class="dot"><i></i><i></i><i></i></div>
    <div id="loadingText">ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”</div>
  </div>

  <!-- Card -->
  <main id="content" role="main" aria-label="ì†Œê°œ ì¹´ë“œ" aria-busy="true">
    <div class="top">
      <img id="profileImg" alt="í”„ë¡œí•„" />
    </div>
    <div class="bottom">
      <h1 id="displayName">ë§ˆì´ ë„¤ì„</h1>
      <div class="tags" id="tagsWrap"></div>
      <div class="btns" id="btnsWrap"></div>
    </div>
  </main>

  <!-- Floating -->
  <div class="fab">
    <button id="authBtn" class="auth" title="ë¡œê·¸ì¸">ğŸ‘¤</button>
    <button id="settingsBtn" title="ì„¤ì •">âš™ï¸</button>
  </div>

  <!-- Settings Panel -->
  <aside id="panel" class="panel" aria-label="ì„¤ì •">
    <div class="ph">
      <strong>íŒ¨ë„ ì„¤ì •</strong>
      <div class="actions">
        <button id="btnReset" class="small">ê¸°ë³¸ê°’</button>
        <button id="btnSave" class="small primary">ì €ì¥</button>
      </div>
    </div>
    <div class="pb">
      <div class="row-2">
        <div>
          <label>í˜ì´ì§€ íƒ€ì´í‹€</label>
          <input id="titleInput" type="text" placeholder="ë¸Œë¼ìš°ì € íƒ­ ì œëª©" />
        </div>
        <div>
          <label>ë¡œë”© ë¬¸êµ¬</label>
          <input id="loadingMsgInput" type="text" placeholder="ë¶ˆëŸ¬ì˜¤ëŠ” ë™ì•ˆ ë³´ì¼ ë¬¸êµ¬" />
        </div>
      </div>

      <div class="row">
        <label>ë””ìŠ¤í”Œë ˆì´ ì´ë¦„</label>
        <input id="nameInput" type="text" placeholder="ì¹´ë“œì— í‘œì‹œí•  ì´ë¦„" />
      </div>

      <!-- ì´ë¯¸ì§€(íŒŒì¼ ì—…ë¡œë“œ â†’ dataURL ì €ì¥) -->
      <div class="row">
        <label>ë°°ê²½ ì´ë¯¸ì§€ (íŒŒì¼ ì„ íƒ)</label>
        <input id="bgText" type="text" placeholder="íŒŒì¼ ì„ íƒ í›„ ìë™ ì±„ì›€" readonly />
        <input id="bgFile" type="file" accept="image/*" class="color" />
      </div>
      <div class="row">
        <label>ë°°ë„ˆ ì´ë¯¸ì§€ (íŒŒì¼ ì„ íƒ)</label>
        <input id="bannerText" type="text" placeholder="íŒŒì¼ ì„ íƒ í›„ ìë™ ì±„ì›€" readonly />
        <input id="bannerFile" type="file" accept="image/*" class="color" />
      </div>
      <div class="row">
        <label>í”„ë¡œí•„ ì´ë¯¸ì§€ (íŒŒì¼ ì„ íƒ)</label>
        <input id="profileText" type="text" placeholder="íŒŒì¼ ì„ íƒ í›„ ìë™ ì±„ì›€" readonly />
        <input id="profileFile" type="file" accept="image/*" class="color" />
      </div>

      <!-- ë¡œë”©/ì˜¤ë²„ë ˆì´/ê·¸ë¦¼ì ìƒ‰ -->
      <div class="row-2">
        <div>
          <label>ë¡œë”© ë°°ê²½ ìƒ‰ (CSS Color)</label>
          <input id="loadingBgInput" type="text" placeholder="rgba(239,244,255,0.9) / #eff4ffcc" />
          <input id="loadingBgPicker" type="color" class="color" />
        </div>
        <div>
          <label>ë¡œë”© ê³µ ìƒ‰ (CSS Color)</label>
          <input id="loadingDotInput" type="text" placeholder="#5865F2" />
          <input id="loadingDotPicker" type="color" class="color" />
        </div>
      </div>
      <div class="row-2">
        <div>
          <label>ë°°ê²½ ì˜¤ë²„ë ˆì´ ìƒ‰ (CSS Color)</label>
          <input id="overlayInput" type="text" placeholder="rgba(255,255,255,0.35)" />
          <input id="overlayPicker" type="color" class="color" />
        </div>
        <div>
          <label>ì¹´ë“œ ê·¸ë¦¼ì ìƒ‰ (CSS Color)</label>
          <input id="shadowInput" type="text" placeholder="rgba(0,0,0,0.25)" />
          <input id="shadowPicker" type="color" class="color" />
        </div>
      </div>

      <!-- íƒœê·¸ -->
      <div class="row">
        <label>íƒœê·¸</label>
        <div id="tagsList" class="list"></div>
        <button id="addTag" class="small">+ íƒœê·¸ ì¶”ê°€</button>
        <div class="note">ê·¸ë¦¼ì ìƒ‰ì„ ë¹„ìš°ë©´ íƒœê·¸ ìƒ‰ê³¼ ë™ì¼í•©ë‹ˆë‹¤.</div>
      </div>

      <!-- ë²„íŠ¼ -->
      <div class="row">
        <label>ë²„íŠ¼</label>
        <div id="linksList" class="list"></div>
        <button id="addLink" class="small">+ ë²„íŠ¼ ì¶”ê°€</button>
        <div class="note">ë²„íŠ¼ì€ â€œì´ë¦„+ë§í¬(URL)â€ë§Œ ì…ë ¥.</div>
      </div>

      <hr/>

      <!-- ê³µê°œ ìŠ¬ëŸ¬ê·¸ -->
      <div class="row-2">
        <div>
          <label>ê³µê°œ ìŠ¬ëŸ¬ê·¸(ë§í¬) â€” ì˜ë¬¸/ìˆ«ì/_/-, 3~32ì</label>
          <input id="slugInput" type="text" placeholder="ì˜ˆ: yunha, 0yunha1, my-name" />
        </div>
        <div style="align-self:end">
          <button id="publishSlug" class="small primary">ìŠ¬ëŸ¬ê·¸ ê²Œì‹œ</button>
        </div>
      </div>
      <div class="note">ì ‘ì†: <code>https://ë„ë©”ì¸/@ìŠ¬ëŸ¬ê·¸</code> ë˜ëŠ” <code>https://ë„ë©”ì¸/ìŠ¬ëŸ¬ê·¸</code> (RenderëŠ” ë¦¬ë¼ì´íŠ¸, GitHub PagesëŠ” 404.html íŠ¸ë¦­)</div>

      <div class="row">
        <label>ê³µìœ /ë°±ì—…</label>
        <div class="share">
          <button id="previewBtn" class="small">ë¯¸ë¦¬ë³´ê¸°</button>
          <button id="saveCloud" class="small">ê³„ì • ì €ì¥</button>
          <button id="loadCloud" class="small">ê³„ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="createShort" class="small">ì§§ì€ ë§í¬</button>
        </div>
      </div>
    </div>
  </aside>

  <!-- Auth Modal -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="mc">
      <div class="mh">
        <strong>ë¡œê·¸ì¸ / íšŒì›ê°€ì…</strong>
        <button id="authClose" class="small">ë‹«ê¸°</button>
      </div>
      <div class="row">
        <label>ì´ë©”ì¼</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>
      </div>
      <div class="row">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <input id="pw" type="password" placeholder="8ì ì´ìƒ" autocomplete="current-password"/>
      </div>
      <div class="note">â€» íšŒì›ê°€ì… ì‹œ <b>ì´ë©”ì¼ ì¸ì¦</b> í›„ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
      <div class="auth-actions">
        <button id="sendReset" class="small">ì¬ì„¤ì • ë©”ì¼</button>
        <button id="btnRegister" class="small primary">íšŒì›ê°€ì…</button>
        <button id="btnLogin" class="small primary">ë¡œê·¸ì¸</button>
        <button id="btnLogout" class="small" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>

  <!-- Supabase: ë„¤ í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ êµì²´ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* =======================
       1) ì—¬ê¸°ë¥¼ ë„ˆì˜ ê°’ìœ¼ë¡œ êµì²´
       ======================= */
    const SUPABASE_URL = "https://jutgrivlikaflkhbdhar.supabase.co";          // ì˜ˆ: "https://xxxx.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1dGdyaXZsaWthZmxraGJkaGFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNTk1MTEsImV4cCI6MjA3MTczNTUxMX0.qGsSDiqtzoUYWvWruRGMzzorDVQAO0MLEpIpgX_BpP8";     // ì˜ˆ: "eyJhbGciOi..."

    const CLOUD_READY = !!(SUPABASE_URL && SUPABASE_ANON_KEY);
    const supabase = CLOUD_READY ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : {
      auth:{
        getUser: async()=>({data:{user:null}}),
        getSession: async()=>({data:{session:null}}),
        onAuthStateChange: ()=>({ data:{ subscription:{ unsubscribe(){} } } }),
        signInWithPassword: async()=>{ throw new Error("Supabase ë¯¸ì„¤ì •"); },
        signUp: async()=>{ throw new Error("Supabase ë¯¸ì„¤ì •"); },
        signOut: async()=>({})
      },
      from:()=>({ select: async()=>({data:null,error:null}), upsert: async()=>({}), insert: async()=>({}), maybeSingle: async()=>({data:null}) })
    };

    /* ============ ê¸°ë³¸ê°’ ============ */
    const DEFAULTS = {
      pageTitle:"MyNameis",
      loadingText:"ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”",
      backgroundUrl:"https://images.unsplash.com/photo-1520975922284-9e0ce8275f5b?q=80&w=1600&auto=format&fit=crop",
      bannerUrl:"https://images.unsplash.com/photo-1549880338-65ddcdfd017b?q=80&w=1600&auto=format&fit=crop",
      profileUrl:"https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=800&auto=format&fit=crop",
      name:"ë§ˆì´ ë„¤ì„",
      loadingBg:"rgba(239,244,255,0.9)",
      loadingDot:"#5865F2",
      overlayColor:"rgba(255,255,255,0.35)",
      cardShadowColor:"rgba(0,0,0,0.25)",
      tags:[
        {text:"ë§ˆì´ë„¤ì„ì´ì¦ˆ", color:"#fd8a8a", shadow:""},
        {text:"ì†Œê°œí˜ì´ì§€",   color:"#fde047", shadow:""},
        {text:"ì›¹ì‚¬ì´íŠ¸",     color:"#93c5fd", shadow:""}
      ],
      buttons:[]
    };

    const LS_KEY = "panelConfig.v3";
    const LENGTH_LIMIT = 1800;

    /* ============ ìœ í‹¸ ============ */
    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const isCssColor = v => /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(v||"") || /^rgba?\(/i.test(v||"");
    const isSafeUrl = u => /^https?:\/\//i.test(u||"") || /^data:image\//i.test(u||"");
    const isDataImg = u => /^data:image\//i.test(u||"");

    function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

    function contrastOn(bg){
      let r,g,b;
      if(/^#/.test(bg)){ let h=bg.slice(1); if(h.length===3) h=h.split('').map(c=>c+c).join(''); const n=parseInt(h,16); r=(n>>16)&255; g=(n>>8)&255; b=n&255; }
      else{ const m=bg.replace(/[^\d.,]/g,"").split(",").map(Number); r=m[0];g=m[1];b=m[2]; }
      const L= (0.2126*(r/255)**2.2 + 0.7152*(g/255)**2.2 + 0.0722*(b/255)**2.2);
      return L>0.6? "#111" : "#fff";
    }

    /* ============ ë¡œë”© ì»¨íŠ¸ë¡¤ëŸ¬ ============ */
    const MIN_LOADING_MS = 800;
    const MAX_LOADING_MS = 6000;
    const start = Date.now();
    let closed = false;
    function closeLoading(){
      if(closed) return;
      const elapsed = Date.now() - start;
      const wait = Math.max(0, MIN_LOADING_MS - elapsed);
      setTimeout(()=>{
        const L=$("#loading"), C=$("#content");
        if(L) L.style.display="none";
        if(C){ C.style.display="block"; C.setAttribute("aria-busy","false"); }
        closed = true;
      }, wait);
    }
    setTimeout(closeLoading, MAX_LOADING_MS);
    window.addEventListener("unhandledrejection", closeLoading);

    function encCfg(cfg){
      const s=JSON.stringify(cfg);
      const bytes=new TextEncoder().encode(s);
      let bin=""; for(let i=0;i<bytes.length;i++) bin+=String.fromCharCode(bytes[i]);
      return btoa(bin);
    }
    function decCfg(s){
      try{
        const bin=atob(s); const bytes=new Uint8Array([...bin].map(c=>c.charCodeAt(0)));
        return JSON.parse(new TextDecoder().decode(bytes));
      }catch{return null;}
    }
    function cleanCParam(){
      try{ const u=new URL(location.href); if(u.searchParams.has("c")){ u.searchParams.delete("c"); history.replaceState(null,"",u); } }catch{}
    }
    function applyOverlay(color){
      const v=isCssColor(color)?color:DEFAULTS.overlayColor;
      let st=document.getElementById("ovStyle"); if(!st){ st=document.createElement("style"); st.id="ovStyle"; document.head.appendChild(st); }
      st.textContent=`body::before{background:${v}!important}`;
    }
    function applyCardShadow(color){
      const v=isCssColor(color)?color:DEFAULTS.cardShadowColor;
      let st=document.getElementById("shStyle"); if(!st){ st=document.createElement("style"); st.id="shStyle"; document.head.appendChild(st); }
      st.textContent=`#content{box-shadow:0 8px 24px ${v}!important}`;
    }

    /* ============ ë Œë” ============ */
    function render(cfg){
      document.title = cfg.pageTitle || cfg.name || document.title;
      $("#loadingText").textContent = cfg.loadingText || DEFAULTS.loadingText;

      const L=$("#loading");
      if(L && cfg.loadingBg) L.style.background = cfg.loadingBg;
      $$(".dot i").forEach(i=>{ if(cfg.loadingDot) i.style.background = cfg.loadingDot; });

      document.body.style.backgroundImage = `url("${cfg.backgroundUrl}")`;
      $(".top").style.backgroundImage = `
        linear-gradient(135deg, rgba(127,90,240,.2), rgba(255,128,191,.2)),
        url("${cfg.bannerUrl}")
      `;
      $("#profileImg").src = cfg.profileUrl || "";
      $("#displayName").textContent = cfg.name || "";

      const tw=$("#tagsWrap"); tw.innerHTML="";
      (cfg.tags||[]).forEach(t=>{
        if(!t.text) return;
        const d=document.createElement("div"); d.className="tag";
        const c = isCssColor(t.color)? t.color : "#93c5fd";
        d.style.background = c;
        d.style.boxShadow = `0 8px 18px ${ t.shadow && isCssColor(t.shadow) ? t.shadow : c }`;
        d.style.color = contrastOn(c);
        d.textContent=t.text;
        tw.appendChild(d);
      });

      const bw=$("#btnsWrap"); bw.innerHTML="";
      (cfg.buttons||[]).forEach(b=>{
        if(!b.label || !isSafeUrl(b.url)) return;
        const a=document.createElement("a"); a.className="btn"; a.target="_blank"; a.rel="noopener";
        a.textContent=b.label; a.href=b.url; bw.appendChild(a);
      });

      applyOverlay(cfg.overlayColor);
      applyCardShadow(cfg.cardShadowColor);
      closeLoading();
    }

    /* ============ DOM ë°”ì¸ë”© ============ */
    const panel=$("#panel"), settingsBtn=$("#settingsBtn"), authBtn=$("#authBtn");
    const titleInput=$("#titleInput"), loadingMsgInput=$("#loadingMsgInput"), nameInput=$("#nameInput");
    const bgText=$("#bgText"), bannerText=$("#bannerText"), profileText=$("#profileText");
    const bgFile=$("#bgFile"), bannerFile=$("#bannerFile"), profileFile=$("#profileFile");
    const loadingBgInput=$("#loadingBgInput"), loadingDotInput=$("#loadingDotInput");
    const loadingBgPicker=$("#loadingBgPicker"), loadingDotPicker=$("#loadingDotPicker");
    const overlayInput=$("#overlayInput"), overlayPicker=$("#overlayPicker");
    const shadowInput=$("#shadowInput"), shadowPicker=$("#shadowPicker");
    const tagsList=$("#tagsList"), linksList=$("#linksList");
    const addTag=$("#addTag"), addLink=$("#addLink");
    const btnSave=$("#btnSave"), btnReset=$("#btnReset");
    const publishSlugBtn=$("#publishSlug"), slugInput=$("#slugInput");
    const previewBtn=$("#previewBtn"), saveCloud=$("#saveCloud"), loadCloud=$("#loadCloud");

    function openPanel(o=true){ panel.classList.toggle("open",o); }
    settingsBtn.addEventListener("click", async ()=>{
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user){ alert("íŒ¨ë„ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”."); openAuth(true); return; }
      openPanel(!panel.classList.contains("open"));
    });

    function addTagRow(tag={text:"",color:"",shadow:""}){
      const tpl=document.createElement("template");
      tpl.innerHTML = `<div class="item tag-item">
        <div class="row-2">
          <div><label>í…ìŠ¤íŠ¸</label><input type="text" class="tag-text" placeholder="ì˜ˆ: ì¹˜ë¦°ì´ì§‘"/></div>
          <div><label>ìƒ‰ìƒ ì½”ë“œ(HEX/rgb/rgba)</label><input type="text" class="tag-color" placeholder="#ff5577 ë˜ëŠ” rgba(255,85,119,.9)"/></div>
        </div>
        <div class="row"><label>ê·¸ë¦¼ì ìƒ‰(ë¹„ìš°ë©´ íƒœê·¸ìƒ‰)</label><input type="text" class="tag-shadow" placeholder="rgba(0,0,0,0.18) / #ff5577"/></div>
        <div style="display:flex; gap:6px; justify-content:flex-end"><button class="small danger tag-del">ì‚­ì œ</button></div>
      </div>`;
      const row=tpl.content.firstElementChild;
      row.querySelector(".tag-text").value = tag.text||"";
      row.querySelector(".tag-color").value = tag.color||"";
      row.querySelector(".tag-shadow").value = tag.shadow||"";
      row.querySelector(".tag-del").addEventListener("click", ()=> row.remove());
      tagsList.appendChild(row);
    }
    function addLinkRow(link={label:"",url:""}){
      const tpl=document.createElement("template");
      tpl.innerHTML = `<div class="item link-item">
        <div class="row"><label>ë²„íŠ¼ ì´ë¦„</label><input type="text" class="link-label" placeholder="ì˜ˆ: ë¬¸ì˜í•˜ê¸°"/></div>
        <div class="row"><label>ì—°ê²° ë§í¬(URL)</label><input type="url" class="link-url" placeholder="https://example.com"/></div>
        <div style="display:flex; gap:6px; justify-content:flex-end"><button class="small danger link-del">ì‚­ì œ</button></div>
      </div>`;
      const row=tpl.content.firstElementChild;
      row.querySelector(".link-label").value = link.label||"";
      row.querySelector(".link-url").value = link.url||"";
      row.querySelector(".link-del").addEventListener("click", ()=> row.remove());
      linksList.appendChild(row);
    }
    addTag.addEventListener("click", ()=> addTagRow());
    addLink.addEventListener("click", ()=> addLinkRow());

    function fillForm(cfg){
      titleInput.value = cfg.pageTitle||"";
      loadingMsgInput.value = cfg.loadingText||"";
      nameInput.value = cfg.name||"";

      bgText.value = isDataImg(cfg.backgroundUrl)? cfg.backgroundUrl : "";
      bannerText.value = isDataImg(cfg.bannerUrl)? cfg.bannerUrl : "";
      profileText.value = isDataImg(cfg.profileUrl)? cfg.profileUrl : "";

      loadingBgInput.value = cfg.loadingBg || DEFAULTS.loadingBg;
      loadingDotInput.value = cfg.loadingDot || DEFAULTS.loadingDot;
      overlayInput.value = cfg.overlayColor || DEFAULTS.overlayColor;
      shadowInput.value = cfg.cardShadowColor || DEFAULTS.cardShadowColor;

      if(/^#/.test(cfg.loadingBg||"")) loadingBgPicker.value = cfg.loadingBg;
      if(/^#/.test(cfg.loadingDot||"")) loadingDotPicker.value = cfg.loadingDot;
      if(/^#/.test(cfg.overlayColor||"")) overlayPicker.value = cfg.overlayColor;
      if(/^#/.test(cfg.cardShadowColor||"")) shadowPicker.value = cfg.cardShadowColor;

      tagsList.innerHTML=""; (cfg.tags||[]).forEach(addTagRow);
      linksList.innerHTML=""; (cfg.buttons||[]).forEach(addLinkRow);
    }

    function collectForm(){
      const tags = $$(".tag-item",tagsList).map(el=>({
        text: el.querySelector(".tag-text").value.trim(),
        color: el.querySelector(".tag-color").value.trim(),
        shadow: el.querySelector(".tag-shadow").value.trim()
      })).filter(t=>t.text);

      const buttons = $$(".link-item",linksList).map(el=>({
        label: el.querySelector(".link-label").value.trim(),
        url: el.querySelector(".link-url").value.trim()
      })).filter(b=>b.label && isSafeUrl(b.url));

      const bg = isDataImg(bgText.value.trim())? bgText.value.trim() : DEFAULTS.backgroundUrl;
      const banner = isDataImg(bannerText.value.trim())? bannerText.value.trim() : DEFAULTS.bannerUrl;
      const profile = isDataImg(profileText.value.trim())? profileText.value.trim() : DEFAULTS.profileUrl;

      return {
        pageTitle: titleInput.value.trim() || nameInput.value.trim() || DEFAULTS.pageTitle,
        loadingText: loadingMsgInput.value.trim() || DEFAULTS.loadingText,
        backgroundUrl: bg,
        bannerUrl: banner,
        profileUrl: profile,
        name: nameInput.value.trim() || DEFAULTS.name,
        loadingBg: loadingBgInput.value.trim() || DEFAULTS.loadingBg,
        loadingDot: loadingDotInput.value.trim() || DEFAULTS.loadingDot,
        overlayColor: overlayInput.value.trim() || DEFAULTS.overlayColor,
        cardShadowColor: shadowInput.value.trim() || DEFAULTS.cardShadowColor,
        tags, buttons
      };
    }

    async function bindFileInput(fileEl, targetText, onApply){
      fileEl?.addEventListener("change", async e=>{
        const f=e.target.files?.[0]; if(!f) return;
        const dataURL = await fileToDataURL(f);
        targetText.value = dataURL;
        onApply?.(dataURL);
        render(collectForm());
      });
    }
    bindFileInput(bgFile, bgText);
    bindFileInput(bannerFile, bannerText);
    bindFileInput(profileFile, profileText, (d)=>{ $("#profileImg").src=d; });

    loadingBgPicker?.addEventListener("input", e=>{ loadingBgInput.value=e.target.value; render(collectForm()); });
    loadingDotPicker?.addEventListener("input", e=>{ loadingDotInput.value=e.target.value; render(collectForm()); });
    overlayPicker?.addEventListener("input", e=>{ overlayInput.value=e.target.value; render(collectForm()); });
    shadowPicker?.addEventListener("input", e=>{ shadowInput.value=e.target.value; render(collectForm()); });

    $("#previewBtn").addEventListener("click", ()=> render(collectForm()));

    btnSave.addEventListener("click", async ()=>{
      const c=collectForm();
      localStorage.setItem(LS_KEY, JSON.stringify(c));
      render(c);
      const enc = encCfg(c);
      const u = new URL(location.href);
      if (enc.length <= LENGTH_LIMIT) u.searchParams.set("c", enc);
      else u.searchParams.delete("c");
      history.replaceState(null,"",u);

      const { data:{ user } } = await supabase.auth.getUser();
      if(user){ await saveToAccount(c); }
      alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      openPanel(false);
    });
    btnReset.addEventListener("click", ()=>{
      if(confirm("ëª¨ë“  ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦´ê¹Œìš”?")){
        localStorage.setItem(LS_KEY, JSON.stringify(DEFAULTS));
        fillForm(DEFAULTS); render(DEFAULTS);
        const u=new URL(location.href); u.searchParams.delete("c"); history.replaceState(null,"",u);
        alert("ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
      }
    });

    /* ============ Supabase ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ============ */
    async function saveToAccount(cfg){
      if(!CLOUD_READY) return;
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user) return;
      const { error } = await supabase.from("configs").upsert({ user_id:user.id, data:cfg });
      if(error) alert(error.message);
    }
    async function loadFromAccount(){
      if(!CLOUD_READY) return;
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user) return alert("ë¡œê·¸ì¸ í•„ìš”");
      const { data, error } = await supabase.from("configs").select("data").eq("user_id", user.id).maybeSingle();
      if(error || !data){ alert("ê³„ì •ì— ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
      const cfg = data.data;
      fillForm(cfg); render(cfg); localStorage.setItem(LS_KEY, JSON.stringify(cfg));
    }
    $("#saveCloud").addEventListener("click", ()=> saveToAccount(collectForm()));
    $("#loadCloud").addEventListener("click", ()=> loadFromAccount());

    /* ============ ìŠ¬ëŸ¬ê·¸ ì €ì¥/ì¡°íšŒ ============ */
    function isValidSlug(s){ return /^[a-zA-Z0-9_-]{3,32}$/.test(s||""); }
    async function fetchBySlug(slug){
      const { data, error } = await supabase.from("short_configs").select("data").eq("code", slug).maybeSingle();
      if(error) return null; return data?.data || null;
    }
    async function publishSlug(slug, cfg){
      if(!CLOUD_READY) return alert("Supabase í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”.");
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user) return alert("ë¡œê·¸ì¸ í›„ ê²Œì‹œí•  ìˆ˜ ìˆì–´ìš”.");
      if(!isValidSlug(slug)) return alert("ì˜ë¬¸/ìˆ«ì/_/-, 3~32ì í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.");

      const existed = await supabase.from("short_configs").select("owner_id").eq("code", slug).maybeSingle();
      if(existed.data && existed.data.owner_id && existed.data.owner_id !== user.id){
        return alert("ì´ë¯¸ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì“°ê³  ìˆëŠ” ìŠ¬ëŸ¬ê·¸ì…ë‹ˆë‹¤.");
      }
      const { error } = await supabase.from("short_configs")
        .upsert({ code: slug, owner_id: user.id, data: cfg }).select("code").single();
      if(error) return alert("ê²Œì‹œ ì‹¤íŒ¨: "+error.message);

      const p1=`${location.origin}/@${slug}`, p2=`${location.origin}/${slug}`, q=`${location.origin}${location.pathname}?s=${encodeURIComponent(slug)}`;
      try{ await navigator.clipboard.writeText(p1); }catch{}
      alert(`ìŠ¬ëŸ¬ê·¸ ê²Œì‹œ ì™„ë£Œ!\n\nì§ì ‘ ê²½ë¡œ(ë¦¬ë¼ì´íŠ¸ í•„ìš”):\n- ${p1}\n- ${p2}\n\ní•­ìƒ ë™ì‘:\n- ${q}`);
    }
    publishSlugBtn.addEventListener("click", ()=> publishSlug(slugInput.value.trim(), collectForm()));

    function getPathSlug(){
      const p = location.pathname;
      if (p === "/" || /index\.html?$/i.test(p)) return null;
      const m = p.match(/^\/(?:@)?([A-Za-z0-9_-]{3,32})\/?$/);
      return m ? m[1] : null;
    }

    /* ============ Auth ëª¨ë‹¬ ============ */
    const authModal=$("#authModal"), authClose=$("#authClose");
    const email=$("#email"), pw=$("#pw"), btnRegister=$("#btnRegister"), btnLogin=$("#btnLogin"), btnLogout=$("#btnLogout"), sendReset=$("#sendReset");
    function openAuth(o=true){ authModal.classList.toggle("open",o); if(o) email.focus(); }
    authBtn.addEventListener("click", async ()=>{
      const { data:{ user } } = await supabase.auth.getUser();
      if(user){
        email.value = user.email || ""; email.disabled = true; pw.value = "";
        btnLogout.style.display=""; btnRegister.style.display="none"; btnLogin.textContent="ì¬ë¡œê·¸ì¸"; openAuth(true);
      } else {
        email.value=""; email.disabled=false; pw.value="";
        btnLogout.style.display="none"; btnRegister.style.display=""; btnLogin.textContent="ë¡œê·¸ì¸"; openAuth(true);
      }
    });
    authClose.addEventListener("click", ()=> openAuth(false));

    btnRegister.addEventListener("click", async ()=>{
      const e=(email.value||"").trim(), p=pw.value;
      if(!e || !p) return alert("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      const { error } = await supabase.auth.signUp({ email:e, password:p, options:{ emailRedirectTo: location.origin + location.pathname } });
      if(error) return alert(error.message);
      alert("íšŒì›ê°€ì… ë©”ì¼ì„ ë³´ëƒˆì–´ìš”. ì¸ì¦ í›„ ë¡œê·¸ì¸í•˜ì„¸ìš”.");
      openAuth(false);
    });
    btnLogin.addEventListener("click", async ()=>{
      const e=(email.value||"").trim(), p=pw.value;
      if(!e || !p) return alert("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      const { error } = await supabase.auth.signInWithPassword({ email:e, password:p });
      if(error){
        const m=(error.message||"").toLowerCase();
        if(m.includes("confirm")||m.includes("verified")) alert("ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì•¼ ë¡œê·¸ì¸í•  ìˆ˜ ìˆì–´ìš”.");
        else alert(error.message);
        return;
      }
      openAuth(false);
      try{ await ensureFirstSignupInit(); await loadFromAccount(); }catch(e){}
    });
    btnLogout.addEventListener("click", async ()=>{ await supabase.auth.signOut(); openAuth(false); });

    sendReset.addEventListener("click", async ()=>{
      const e=(email.value||"").trim(); if(!e) return alert("ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");
      const { error } = await supabase.auth.resetPasswordForEmail(e, { redirectTo: location.origin + location.pathname });
      if(error) return alert(error.message);
      alert("ì¬ì„¤ì • ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.");
    });

    async function ensureFirstSignupInit(){
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user) return;
      const r = await supabase.from("configs").select("user_id").eq("user_id", user.id).maybeSingle();
      if(!r.data){
        await supabase.from("configs").insert({ user_id:user.id, data:DEFAULTS });
      }
    }

    /* ============ ë¶€íŒ… ============ */
    (async ()=>{
      try{
        let cfg=null;
        const pathSlug = getPathSlug();
        const url = new URL(location.href);
        const s = url.searchParams.get("s");
        const c = url.searchParams.get("c");

        if(pathSlug && CLOUD_READY) try{ cfg = await fetchBySlug(pathSlug); }catch{}
        if(!cfg && s && CLOUD_READY) try{ cfg = await fetchBySlug(s); }catch{}
        if(!cfg && c){ cfg = decCfg(c); cleanCParam(); }
        if(!cfg){
          try{ const raw=localStorage.getItem(LS_KEY); if(raw) cfg=JSON.parse(raw); }catch{}
        }
        if(!cfg) cfg = JSON.parse(JSON.stringify(DEFAULTS));

        fillForm(cfg); render(cfg);
      }catch(e){
        console.error("boot error:", e);
        fillForm(DEFAULTS); render(DEFAULTS);
      }
    })();
  </script>
</body>
</html>
