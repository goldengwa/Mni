<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MyNameis</title>
  <style>
    :root{ --card-w:360px; }
    *{ box-sizing:border-box }
    body{
      margin:0; padding:0; min-height:100vh;
      font-family:"Pretendard",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      display:flex; justify-content:center; align-items:center;
      background:url("https://img.freepik.com/premium-photo/abstract-background-design-hd-olive-green-color_851755-74064.jpg?semt=ais_hybrid&w=740&q=80") no-repeat center/cover fixed;
      position:relative;
    }
    /* 기본값은 CSS에서 .35, JS로 사용자 지정값을 !important로 덮어씌움 */
    body::before{ content:""; position:absolute; inset:0; background:rgba(255,255,255,.35); z-index:0 }
    #content,#loading{ position:relative; z-index:1 }

    /* loading */
    #loading{
      position:fixed; inset:0; display:flex; flex-direction:column; gap:10px;
      justify-content:center; align-items:center; background:rgba(239,244,255,.9);
      color:#000; font-size:15px; font-weight:600; z-index:1000;
    }
    .dot-loader{ display:flex; gap:8px; margin-bottom:6px }
    .dot-loader span{ width:12px; height:12px; background:#5865F2; border-radius:50%;
      animation:jump .6s infinite alternate ease-in-out }
    .dot-loader span:nth-child(2){ animation-delay:.2s }
    .dot-loader span:nth-child(3){ animation-delay:.4s }
    @keyframes jump{ from{transform:translateY(0)} to{transform:translateY(-10px)} }

    /* card */
    #content{
      display:none; width:var(--card-w); border-radius:16px; overflow:hidden; background:#fff;
      box-shadow:0 8px 24px rgba(0,0,0,.25); animation:fadeIn 1s ease;
    }
    .card-top{
      background:
        linear-gradient(135deg, rgba(127,90,240,.2), rgba(255,128,191,.2)),
        url("https://img.freepik.com/premium-photo/abstract-background-design-hd-olive-green-color_851755-74064.jpg?semt=ais_hybrid&w=740&q=80") center/cover no-repeat;
      padding:60px 20px 80px; text-align:center; color:#fff; position:relative;
    }
    .card-top img{
      width:110px; height:110px; border-radius:50%; border:4px solid #fff; object-fit:cover;
      box-shadow:0 4px 12px rgba(0,0,0,.3); position:absolute; bottom:-55px; left:50%;
      transform:translateX(-50%); background:#fff;
    }
    .card-bottom{ padding:70px 25px 30px; text-align:center }
    .card-bottom h1{ margin:-5px 0 10px; font-size:24px; font-weight:800; color:#111 }
    .tags{ display:flex; justify-content:center; gap:10px; margin-bottom:15px; flex-wrap:wrap }
    .tag{
      padding:6px 14px; border-radius:999px; font-size:12px; font-weight:700;
      box-shadow:0 4px 10px rgba(0,0,0,.12);
      background:#eef2ff; color:#3730a3;
    }
    .links{ display:grid; gap:10px }
    .link-btn{
      display:block; text-decoration:none; text-align:center; padding:12px 16px; border-radius:12px;
      background:#111; color:#fff; font-weight:800; border:1px solid #111;
    }

    /* floating actions */
    .fab{ position:fixed; bottom:16px; right:16px; display:flex; gap:8px; flex-wrap:wrap; z-index:1200 }
    .btn{
      padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; font-weight:800; cursor:pointer;
    }
    .btn-primary{ background:#111; color:#fff; border-color:#111 }
    .btn-ghost{ background:#f9fafb }
    .btn-danger{ background:#fee2e2; border-color:#fecaca; color:#991b1b }

    /* settings panel */
    .settings-panel{
      position:fixed; top:8%; left:8px; right:8px; z-index:1100; background:#fff; border:1px solid #eef0f3;
      border-radius:12px; box-shadow:0 10px 28px rgba(0,0,0,.25); display:none; flex-direction:column; max-width:720px;
    }
    .settings-panel.open{ display:flex }
    .sp-head{ display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid #f0f2f5 }
    .sp-title{ font-weight:800 }
    .sp-body{ padding:12px; max-height:calc(75vh - 56px); overflow:auto }
    .sp-actions{ padding:10px 12px; border-top:1px solid #f0f2f5; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end }
    .row{ display:grid; gap:6px; margin:10px 0 }
    .row-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:10px 0 }
    label{ font-size:12px; color:#6b7280; font-weight:700 }
    input, select{
      width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px; background:#fff;
    }
    .list{ display:flex; flex-direction:column; gap:8px }
    .item{ border:1px solid #eef0f3; border-radius:10px; padding:10px; display:grid; gap:8px }
    .item-head{ display:flex; align-items:center; justify-content:space-between; gap:8px }
    .item-actions{ display:flex; gap:6px }
    .btn-small{ padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; cursor:pointer; font-weight:700; font-size:12px; }
    .hr{ height:1px; background:#f0f2f5; margin:10px 0 }
    .note{ font-size:12px; color:#6b7280 }
    .color-picker{ margin-top:6px; width:100%; height:40px; padding:0; border:none; }

    /* auth modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.05); display:none; align-items:center; justify-content:center; z-index:1300 }
    .modal.open{ display:flex }
    .modal-card{ width:min(480px, 92vw); background:#fff; border-radius:12px; box-shadow:0 10px 28px rgba(0,0,0,.25); padding:16px }
    .modal-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
    .modal-title{ font-weight:800 }
    .right{ margin-left:auto }
    .pill{ font-size:12px; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; }
    .auth-row{ display:grid; grid-template-columns:1fr; gap:8px; margin:8px 0 }
    .auth-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px }
    .login-hint{ font-size:12px; color:#6b7280 }

    @media (min-width: 900px){
      .settings-panel{ left:50%; right:auto; width:560px; margin-left:-280px; border-radius:16px }
      .sp-body{ max-height:calc(85vh - 56px) }
    }
  </style>
</head>
<body>
  <!-- loading -->
  <div id="loading">
    <div class="dot-loader"><span></span><span></span><span></span></div>
    <span id="loadingText">불러오고 있어요</span>
  </div>

  <!-- content card -->
  <div id="content">
    <div class="card-top" id="banner">
      <img id="profile" alt="profile"/>
    </div>
    <div class="card-bottom">
      <h1 id="displayName">마이네임</h1>
      <div class="tags" id="tagBox"></div>
      <div class="links" id="linkBox"></div>
    </div>
  </div>

  <!-- floating actions -->
  <div class="fab">
    <button class="btn btn-primary" id="openPanelBtn">패널 설정</button>
    <button class="btn" id="saveToAccountBtn">클라우드 저장</button>
    <button class="btn" id="loadFromAccountBtn">클라우드 불러오기</button>
    <button class="btn" id="createShortBtn">짧은 링크 만들기</button>
    <button class="btn btn-ghost" id="authToggle">로그인/계정</button>
  </div>

  <!-- settings panel -->
  <div class="settings-panel" id="settingsPanel" aria-hidden="true">
    <div class="sp-head">
      <strong class="sp-title">패널 설정</strong>
      <span class="right note">로그인 안 했으면 클라우드 기능은 숨겨질 수 있어요</span>
      <button class="btn-small" id="closePanelBtn">닫기</button>
    </div>
    <div class="sp-body">
      <div class="row-2">
        <div>
          <label>페이지 제목</label>
          <input id="pageTitleInput" type="text" placeholder="브라우저 탭에 표시될 제목"/>
        </div>
        <div>
          <label>로딩 문구</label>
          <input id="loadingMsgInput" type="text" placeholder="불러오는 동안 보일 문구"/>
        </div>
      </div>

      <div class="row">
        <label>디스플레이 이름</label>
        <input id="nameInput" type="text" placeholder="카드에 표시할 이름"/>
      </div>

      <div class="row">
        <label>배경 사진 (파일 업로드만)</label>
        <input id="bgInput" type="text" placeholder="파일 선택만 가능" readonly />
        <input id="bgFile" type="file" accept="image/*" class="color-picker" />
      </div>

      <div class="row">
        <label>배너 사진 (파일 업로드만)</label>
        <input id="bannerInput" type="text" placeholder="파일 선택만 가능" readonly />
        <input id="bannerFile" type="file" accept="image/*" class="color-picker" />
      </div>

      <div class="row">
        <label>프로필 사진 (파일 업로드만)</label>
        <input id="profileInput" type="text" placeholder="파일 선택만 가능" readonly />
        <input id="profileFile" type="file" accept="image/*" class="color-picker" />
      </div>

      <!-- 로딩 색상 -->
      <div class="row-2">
        <div>
          <label>로딩 배경 색 (CSS Color)</label>
          <input id="loadingBgInput" type="text" placeholder="rgba(239,244,255,0.9) / #eff4ffcc"/>
          <input id="loadingBgPicker" type="color" class="color-picker"/>
        </div>
        <div>
          <label>로딩 공 색 (CSS Color)</label>
          <input id="loadingDotInput" type="text" placeholder="#5865F2 / rgb(88,101,242)"/>
          <input id="loadingDotPicker" type="color" class="color-picker"/>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn-small" id="addTagBtn">태그 추가</button>
          <button class="btn-small" id="addLinkBtn">버튼 추가</button>
          <button class="btn-small" id="previewBtn">미리보기</button>
        </div>
      </div>

      <div class="row">
        <div class="list" id="tagList"></div>
        <div class="list" id="linkList" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="sp-actions">
      <button class="btn-small btn-ghost" id="exportBtn">내보내기(JSON)</button>
      <button class="btn-small btn-ghost" id="importBtn">가져오기(JSON)</button>
      <span class="right"></span>
      <button class="btn-small" id="resetBtn">기본값</button>
      <button class="btn-small btn-primary" id="saveBtn">저장</button>
    </div>
  </div>

  <!-- templates -->
  <template id="tagTpl">
    <div class="item tag-item">
      <div class="item-head">
        <strong>태그</strong>
        <div class="item-actions"><button class="btn-small btn-danger tag-del">삭제</button></div>
      </div>
      <div class="row-2">
        <div>
          <label>텍스트</label>
          <input type="text" class="tag-text" placeholder="예: 치린이집"/>
        </div>
        <div>
          <label>색상</label>
          <select class="tag-color">
            <option value="tag-blue">파랑</option>
            <option value="tag-yellow">노랑</option>
            <option value="tag-pink">핑크</option>
            <option value="tag-gray">회색</option>
          </select>
        </div>
      </div>
      <div class="row">
        <label>색상 코드 (선택) — HEX 또는 rgb/rgba</label>
        <input type="text" class="tag-color-code" placeholder="#ff5577 또는 rgb(255,85,119)"/>
        <input type="color" class="tag-color-picker color-picker"/>
      </div>
      <div class="row">
        <label>태그 그림자 색 (선택) — 비우면 태그 색과 동일</label>
        <input type="text" class="tag-shadow-code" placeholder="rgba(0,0,0,0.18) / #c7d2fe"/>
        <input type="color" class="tag-shadow-picker color-picker"/>
      </div>
    </div>
  </template>

  <template id="linkTpl">
    <div class="item link-item">
      <div class="item-head">
        <strong>버튼</strong>
        <div class="item-actions"><button class="btn-small btn-danger link-del">삭제</button></div>
      </div>
      <div class="row">
        <label>버튼 이름</label>
        <input type="text" class="link-label" placeholder="예: 신고문의"/>
      </div>
      <div class="row">
        <label>연결 링크(URL)</label>
        <input type="url" class="link-url" placeholder="https://example.com"/>
      </div>
    </div>
  </template>

  <!-- Auth Modal -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <strong class="modal-title">계정</strong>
        <span class="pill" id="authState">로그아웃 상태</span>
        <button class="btn-small" id="authClose">닫기</button>
      </div>
      <div class="auth-row">
        <label>이메일</label>
        <input id="authEmail" type="email" placeholder="you@example.com"/>
      </div>
      <div class="auth-row">
        <label>비밀번호</label>
        <input id="authPw" type="password" placeholder="8자 이상"/>
      </div>
      <div class="auth-actions">
        <button class="btn-small" id="sendResetBtn">비밀번호 초기화 메일</button>
        <span class="right"></span>
        <button class="btn-small" id="loginBtn">로그인</button>
        <button class="btn-small btn-primary" id="registerBtn">회원가입</button>
        <button class="btn-small btn-danger" id="logoutBtn">로그아웃</button>
      </div>
      <p class="login-hint">최초 회원가입 후 첫 로그인 시, 서버에 기본 패널 설정이 자동 생성됩니다.</p>
    </div>
  </div>

  <!-- Password Update Modal -->
  <div class="modal" id="pwModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <strong class="modal-title">비밀번호 변경</strong>
        <button class="btn-small" id="pwClose">닫기</button>
      </div>
      <div class="auth-row">
        <label>새 비밀번호</label>
        <input id="newPw1" type="password" placeholder="8자 이상"/>
      </div>
      <div class="auth-row">
        <label>새 비밀번호 확인</label>
        <input id="newPw2" type="password" placeholder="다시 입력"/>
      </div>
      <div class="auth-actions">
        <span class="right"></span>
        <button class="btn-small btn-primary" id="pwUpdateBtn">비밀번호 변경</button>
      </div>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://jutgrivlikaflkhbdhar.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1dGdyaXZsaWthZmxraGJkaGFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNTk1MTEsImV4cCI6MjA3MTczNTUxMX0.qGsSDiqtzoUYWvWruRGMzzorDVQAO0MLEpIpgX_BpP8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 키 미설정 시 클라우드 관련 버튼/모달 숨김
    const CLOUD_READY = SUPABASE_URL.startsWith("https://") && !SUPABASE_URL.includes("<YOUR-") && !SUPABASE_ANON_KEY.includes("<YOUR-");
    window.addEventListener("DOMContentLoaded", ()=>{
      if(!CLOUD_READY){
        document.getElementById("authToggle").style.display="none";
        document.getElementById("saveToAccountBtn").style.display="none";
        document.getElementById("loadFromAccountBtn").style.display="none";
      }
    });
  </script>

  <script>
  /* ===================== 기본값/유틸 ===================== */
  const DEFAULTS = {
    pageTitle: "MyNameis",
    loadingText: "불러오고 있어요",
    backgroundUrl: "https://img.freepik.com/premium-photo/abstract-background-design-hd-olive-green-color_851755-74064.jpg?semt=ais_hybrid&w=740&q=80",
    bannerUrl:     "https://img.freepik.com/premium-photo/abstract-background-design-hd-olive-green-color_851755-74064.jpg?semt=ais_hybrid&w=740&q=80",
    profileUrl:    "https://img.freepik.com/premium-photo/abstract-background-design-hd-olive-green-color_851755-74064.jpg?semt=ais_hybrid&w=740&q=80",
    name: "마이네임",
    loadingBg: "rgba(239,244,255,0.9)",
    loadingDot: "#5865F2",
    overlayColor: "rgba(255,255,255,0.35)",
    tags: [],
    links: []
  };
  const LS_KEY = "mynameis.panel.config";

  const $ = (q, el=document)=> el.querySelector(q);
  const $$ = (q, el=document)=> Array.from(el.querySelectorAll(q));

  function fileToDataURL(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file);
    });
  }

  function makeTagNode(t){
    const s = document.createElement('span');
    s.className = 'tag';
    const color = (t.colorCode && t.colorCode.trim()) || null;
    const shadow = (t.shadowCode && t.shadowCode.trim()) || color || 'rgba(0,0,0,0.12)';
    if(color){ s.style.background = color; s.style.color = '#111'; }
    s.style.boxShadow = `0 4px 10px ${shadow}`;
    s.textContent = t.text || '';
    return s;
  }

  function render(cfg){
    document.title = cfg.pageTitle || 'MyNameis';
    $('#loadingText').textContent = cfg.loadingText || '불러오고 있어요';
    $('#displayName').textContent = cfg.name || '마이네임';

    // 배경/배너/프로필
    if(cfg.backgroundUrl){ document.body.style.backgroundImage = `url("${cfg.backgroundUrl}")`; }
    if(cfg.bannerUrl){ $('#banner').style.backgroundImage =
      `linear-gradient(135deg, rgba(127,90,240,.2), rgba(255,128,191,.2)), url("${cfg.bannerUrl}")`; }
    if(cfg.profileUrl){ $('#profile').src = cfg.profileUrl; }

    // 로딩 색
    $('#loading').style.background = cfg.loadingBg || DEFAULTS.loadingBg;
    $$('.dot-loader span').forEach(el=>{ el.style.background = cfg.loadingDot || DEFAULTS.loadingDot; });

    // 오버레이
    document.body.style.setProperty('--overlay-color', cfg.overlayColor || DEFAULTS.overlayColor);
    document.body.style.setProperty('background', `url("${cfg.backgroundUrl||DEFAULTS.backgroundUrl}") no-repeat center/cover fixed`);
    document.body.style.setProperty('--dummy','0'); // noop
    document.body.style.setProperty('cssText', document.body.style.cssText); // keep inline precedence
    document.body.style.setProperty('backgroundImage', `url("${cfg.backgroundUrl||DEFAULTS.backgroundUrl}")`);
    document.body.style.setProperty('backgroundAttachment', 'fixed');

    // 카드 내용
    const tagBox = $('#tagBox'); tagBox.innerHTML='';
    (cfg.tags||[]).forEach(t=> tagBox.appendChild(makeTagNode(t)));
    const linkBox = $('#linkBox'); linkBox.innerHTML='';
    (cfg.links||[]).forEach(l=>{
      const a = document.createElement('a');
      a.className='link-btn'; a.href=l.url||'#'; a.target='_blank'; a.textContent=l.label||'버튼';
      linkBox.appendChild(a);
    });

    // 화면 표시
    $('#content').style.display='block';
    $('#loading').style.display='none';
  }

  function fillForm(cfg){
    $('#pageTitleInput').value = cfg.pageTitle||'';
    $('#loadingMsgInput').value = cfg.loadingText||'';
    $('#nameInput').value = cfg.name||'';
    $('#loadingBgInput').value = cfg.loadingBg||'';
    $('#loadingDotInput').value = cfg.loadingDot||'';
    // 파일 인풋 텍스트는 미리보기용
    $('#bgInput').value = cfg.backgroundUrl ? '(선택됨)' : '';
    $('#bannerInput').value = cfg.bannerUrl ? '(선택됨)' : '';
    $('#profileInput').value = cfg.profileUrl ? '(선택됨)' : '';

    const tagList = $('#tagList'); tagList.innerHTML='';
    (cfg.tags||[]).forEach(t=> addTagRow(t));
    const linkList = $('#linkList'); linkList.innerHTML='';
    (cfg.links||[]).forEach(l=> addLinkRow(l));
  }

  function collectForm(){
    const cfg = {
      pageTitle: $('#pageTitleInput').value.trim() || DEFAULTS.pageTitle,
      loadingText: $('#loadingMsgInput').value.trim() || DEFAULTS.loadingText,
      name: $('#nameInput').value.trim() || DEFAULTS.name,
      loadingBg: $('#loadingBgInput').value.trim() || DEFAULTS.loadingBg,
      loadingDot: $('#loadingDotInput').value.trim() || DEFAULTS.loadingDot,
      overlayColor: DEFAULTS.overlayColor, // (UI 항목은 그대로)
      backgroundUrl: window.__bgDataURL || DEFAULTS.backgroundUrl,
      bannerUrl: window.__bannerDataURL || DEFAULTS.bannerUrl,
      profileUrl: window.__profileDataURL || DEFAULTS.profileUrl,
      tags: [],
      links: []
    };
    $$('.tag-item').forEach(item=>{
      const text = $('.tag-text', item).value.trim();
      const colorCode = $('.tag-color-code', item).value.trim();
      const shadowCode = $('.tag-shadow-code', item).value.trim();
      if(text){
        cfg.tags.push({ text, colorCode, shadowCode });
      }
    });
    $$('.link-item').forEach(item=>{
      const label = $('.link-label', item).value.trim();
      const url = $('.link-url', item).value.trim();
      if(label && url){ cfg.links.push({ label, url }); }
    });
    return cfg;
  }

  function addTagRow(data={}){
    const tpl = $('#tagTpl').content.cloneNode(true);
    const root = tpl.querySelector('.tag-item');
    $('.tag-text',root).value = data.text||'';
    $('.tag-color-code',root).value = data.colorCode||'';
    $('.tag-shadow-code',root).value = data.shadowCode||'';
    $('.tag-color-picker',root).addEventListener('input', e=>{
      $('.tag-color-code',root).value = e.target.value;
    });
    $('.tag-shadow-picker',root).addEventListener('input', e=>{
      $('.tag-shadow-code',root).value = e.target.value;
    });
    $('.tag-del',root).addEventListener('click', ()=> root.remove());
    $('#tagList').appendChild(tpl);
  }

  function addLinkRow(data={}){
    const tpl = $('#linkTpl').content.cloneNode(true);
    const root = tpl.querySelector('.link-item');
    $('.link-label',root).value = data.label||'';
    $('.link-url',root).value = data.url||'';
    $('.link-del',root).addEventListener('click', ()=> root.remove());
    $('#linkList').appendChild(tpl);
  }

  // data-url 파일 업로드 (URL 입력 없이 파일만)
  async function bindFilePicker(inputEl, fileEl, holder){
    fileEl.addEventListener('change', async ()=>{
      const f = fileEl.files && fileEl.files[0];
      if(!f) return;
      const url = await fileToDataURL(f);
      window[holder] = url;
      inputEl.value = '(선택됨)';
      render(collectForm());
    });
  }

  // 단축 인코딩/디코딩(길이 절약용) – 기존 로직 유지
  function encodeCfg(c){ return btoa(unescape(encodeURIComponent(JSON.stringify(c)))); }
  function decodeCfg(s){ try{ return JSON.parse(decodeURIComponent(escape(atob(s)))); }catch{ return null; } }

  /* ===================== 초기 로드 ===================== */
  window.addEventListener('DOMContentLoaded', ()=>{
    bindFilePicker($('#bgInput'), $('#bgFile'), '__bgDataURL');
    bindFilePicker($('#bannerInput'), $('#bannerFile'), '__bannerDataURL');
    bindFilePicker($('#profileInput'), $('#profileFile'), '__profileDataURL');

    // 컬러피커 ↔ 텍스트 동기화
    const loadingBgPicker = $('#loadingBgPicker');
    const loadingDotPicker = $('#loadingDotPicker');
    loadingBgPicker?.addEventListener('input', e=>{ $('#loadingBgInput').value = e.target.value; render(collectForm()); });
    loadingDotPicker?.addEventListener('input', e=>{ $('#loadingDotInput').value = e.target.value; render(collectForm()); });

    // URL 우선순위: ?s(짧은코드) > ?c(설정) > localStorage > DEFAULTS
    (async ()=>{
      const u = new URL(location.href);
      const code = u.searchParams.get('s');
      const cstr = u.searchParams.get('c');
      let cfg = null;

      if(code && CLOUD_READY){
        cfg = await fetchShortByCode(code);
      }else if(cstr){
        cfg = decodeCfg(cstr);
      }else{
        try{ cfg = JSON.parse(localStorage.getItem(LS_KEY)||'null'); }catch{}
      }
      if(!cfg) cfg = DEFAULTS;

      fillForm(cfg);
      render(cfg);
    })();
  });

  /* ===================== 패널 열기/저장 등 이벤트 ===================== */
  const panel = $('#settingsPanel');
  function openPanel(o=true){ panel.classList.toggle('open', o); panel.setAttribute('aria-hidden', o?'false':'true'); }
  $('#openPanelBtn').addEventListener('click', ()=>{
    // (기존 동작 그대로 사용) 로그인 강제는 하지 않음
    openPanel(true);
  });
  $('#closePanelBtn').addEventListener('click', ()=> openPanel(false));

  $('#addTagBtn').addEventListener('click', ()=> addTagRow());
  $('#addLinkBtn').addEventListener('click', ()=> addLinkRow());
  $('#previewBtn').addEventListener('click', ()=> render(collectForm()));

  // 저장 → 로컬 + 주소 ?c= 갱신(새로고침 유지) + 로그인 시 클라우드 업로드
  $('#saveBtn').addEventListener('click', async ()=>{
    const c = collectForm();
    localStorage.setItem(LS_KEY, JSON.stringify(c));
    render(c);
    try{
      const u=new URL(location.href);
      u.searchParams.set("c", encodeCfg(c));
      history.replaceState(null,"",u);
    }catch{}
    if (CLOUD_READY && currentUser) { await saveToAccountRemote(c); }
    alert("저장되었습니다.");
    openPanel(false);
  });

  $('#resetBtn').addEventListener('click', ()=>{
    if(confirm("모든 설정을 기본값으로 되돌릴까요?")){
      localStorage.setItem(LS_KEY, JSON.stringify(DEFAULTS));
      fillForm(DEFAULTS); render(DEFAULTS);
      const u=new URL(location.href); u.searchParams.set("c", encodeCfg(DEFAULTS)); history.replaceState(null,"",u);
      alert("초기화했습니다.");
    }
  });

  $('#exportBtn').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(collectForm(),null,2)], {type:"application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download="panel-config.json"; a.click();
    URL.revokeObjectURL(a.href);
  });

  $('#importBtn').addEventListener('click', ()=>{
    const inp=document.createElement("input"); inp.type="file"; inp.accept="application/json";
    inp.onchange=()=>{ const f=inp.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{ try{ const c=JSON.parse(r.result); fillForm(c); render(c); alert("가져오기 완료. 저장을 눌러 반영하세요."); }catch{ alert("잘못된 JSON 파일입니다."); } };
      r.readAsText(f);
    };
    inp.click();
  });

  $('#shareLinkBtn')?.addEventListener('click', ()=>{
    const encoded = encodeCfg(collectForm());
    const url = new URL(location.href); url.searchParams.set("c", encoded);
    navigator.clipboard?.writeText(url.toString());
    prompt("공유 링크를 복사해가세요:", url.toString());
  });

  /* ===================== Supabase 저장/불러오기 ===================== */
  async function saveToAccountRemote(cfg){
    if(!CLOUD_READY) return alert("클라우드 기능은 키 설정 후 사용 가능합니다.");
    const { data:{ user }, error:e1 } = await supabase.auth.getUser();
    if (e1 || !user) return alert("로그인이 필요합니다.");
    const { error } = await supabase.from("configs").upsert({ user_id:user.id, data:cfg });
    if (error) return alert(error.message);
    alert("클라우드에 저장 완료");
  }
  async function loadFromAccountRemote(){
    if(!CLOUD_READY) return alert("클라우드 기능은 키 설정 후 사용 가능합니다.");
    const { data:{ user }, error:e1 } = await supabase.auth.getUser();
    if (e1 || !user) return alert("로그인이 필요합니다.");
    const { data, error } = await supabase.from("configs").select("data").eq("user_id", user.id).single();
    if (error || !data) return alert("계정에 저장된 설정이 없습니다.");
    const cfg = data.data;
    fillForm(cfg); render(cfg); localStorage.setItem(LS_KEY, JSON.stringify(cfg));
    // 주소에는 넣지 않음(길이 문제 예방)
    const u=new URL(location.href); u.searchParams.delete("c"); history.replaceState(null,"",u);
    alert("계정에서 불러왔습니다.");
  }
  document.getElementById("saveToAccountBtn").addEventListener("click", ()=> saveToAccountRemote(collectForm()));
  document.getElementById("loadFromAccountBtn").addEventListener("click", ()=> loadFromAccountRemote());

  /* ===== Supabase ‘짧은 링크’ ===== */
  function genCode(n=8){ const chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; let s=""; for(let i=0;i<n;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }
  async function createShortLink(cfg){
    if(!CLOUD_READY) return alert("클라우드 키 설정 후 사용 가능합니다.");
    const { data:{ user } } = await supabase.auth.getUser();
    if(!user){ alert("짧은 링크를 만들려면 먼저 로그인해주세요."); openAuth(true); return; }

    let ask = prompt("짧은 코드(영문/숫자/언더바/하이픈, 4~32자). 비우면 자동 생성됩니다.","");
    ask = (ask||"").trim();
    if(ask && !/^[a-zA-Z0-9_-]{4,32}$/.test(ask)){ alert("형식이 올바르지 않아요."); return; }
    const code = ask || genCode(8);

    const { data, error } = await supabase
      .from("short_configs")
      .upsert({ code, owner_id: user.id, data: cfg })
      .select("code")
      .single();

    if(error){ alert("저장 실패: "+error.message); return; }

    const shortUrl = `${location.origin}${location.pathname}?s=${encodeURIComponent(data.code)}`;
    await navigator.clipboard?.writeText(shortUrl);
    prompt("짧은 링크가 만들어졌어요. 복사해서 사용하세요:", shortUrl);
  }
  async function fetchShortByCode(code){
    const { data, error } = await supabase
      .from("short_configs")
      .select("data")
      .eq("code", code)
      .single();
    if(error){ console.warn(error.message); return null; }
    return data?.data || null;
  }
  document.getElementById("createShortBtn").addEventListener("click", ()=> createShortLink(collectForm()));

  /* ===== 인증(요약) ===== */
  let currentUser = null;
  const authModal = $("#authModal"), authEmail=$("#authEmail"), authPw=$("#authPw");
  const loginBtn=$("#loginBtn"), registerBtn=$("#registerBtn"), logoutBtn=$("#logoutBtn"), authClose=$("#authClose");
  const sendResetBtn = $("#sendResetBtn");
  const pwModal = $("#pwModal"), pwClose = $("#pwClose"), newPw1=$("#newPw1"), newPw2=$("#newPw2"), pwUpdateBtn=$("#pwUpdateBtn");
  const authStateSpan = $("#authState");

  function openAuth(o=true){ authModal.classList.toggle("open", o); if(o){ authEmail.focus(); } }
  function openPw(o=true){ pwModal.classList.toggle("open", o); if(o){ newPw1.focus(); } }

  authClose.addEventListener("click", ()=> openAuth(false));
  pwClose.addEventListener("click", ()=> openPw(false));
  document.getElementById("authToggle").addEventListener("click", ()=> openAuth(true));

  function updateAuthUI(){
    authStateSpan.textContent = currentUser ? `로그인: ${currentUser.email||currentUser.phone||'사용자'}` : "로그아웃 상태";
  }

  loginBtn.addEventListener("click", async ()=>{
    const email = authEmail.value.trim();
    const password = authPw.value.trim();
    if(!email || !password) return alert("이메일/비밀번호를 입력하세요.");
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) return alert(error.message);
    alert("로그인 되었습니다.");
    openAuth(false);
  });

  registerBtn.addEventListener("click", async ()=>{
    const email = authEmail.value.trim();
    const password = authPw.value.trim();
    if(!email || !password) return alert("이메일/비밀번호를 입력하세요.");
    const { data, error } = await supabase.auth.signUp({ email, password });
    if(error) return alert(error.message);
    alert("가입이 요청되었습니다. 이메일 인증을 완료한 뒤 로그인하세요.");
  });

  logoutBtn.addEventListener("click", async ()=>{
    await supabase.auth.signOut();
    alert("로그아웃 되었습니다.");
  });

  sendResetBtn.addEventListener("click", async ()=>{
    const email = authEmail.value.trim();
    if(!email) return alert("메일 주소를 입력하세요.");
    const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: location.href });
    if(error) return alert(error.message);
    alert("비밀번호 재설정 메일을 보냈습니다.");
  });

  pwUpdateBtn.addEventListener("click", async ()=>{
    const p1 = newPw1.value.trim(), p2 = newPw2.value.trim();
    if(!p1 || p1.length<8) return alert("8자 이상 입력해주세요.");
    if(p1!==p2) return alert("비밀번호가 일치하지 않습니다.");
    const { error } = await supabase.auth.updateUser({ password: p1 });
    if(error) return alert(error.message);
    alert("비밀번호가 변경되었습니다.");
    openPw(false);
  });

  // ★★★★★ 최초 회원가입(첫 로그인) 시 기본 설정 자동 생성 ★★★★★
  async function ensureFirstSignupInit(user){
    try{
      // 이미 설정이 있는지 확인
      const { data:rows, error } = await supabase
        .from('configs')
        .select('user_id')
        .eq('user_id', user.id)
        .limit(1);

      if(error){ console.warn('configs 조회 실패:', error.message); return; }

      const hasRow = Array.isArray(rows) && rows.length > 0;
      if(!hasRow){
        // 없으면 DEFAULTS로 생성
        const { error:insErr } = await supabase
          .from('configs')
          .insert({ user_id: user.id, data: DEFAULTS });
        if(insErr){ console.warn('기본 설정 생성 실패:', insErr.message); return; }

        // 로컬에도 반영(초기화 의도): 단, 사용자가 이미 편집해 둔 로컬값은 유지하고 싶다면 아래 줄을 주석 처리
        localStorage.setItem(LS_KEY, JSON.stringify(DEFAULTS));
        fillForm(DEFAULTS);
        render(DEFAULTS);
        console.info('[init] 최초 가입 사용자 기본 설정 생성 완료');
      }
    }catch(e){
      console.warn('ensureFirstSignupInit 오류:', e);
    }
  }

  // 인증 상태 변화 감지
  supabase.auth.onAuthStateChange(async (event, session)=>{
    currentUser = session?.user || null;
    updateAuthUI();

    // 첫 로그인 또는 초기 세션 시 기본 설정 자동 생성 시도(있으면 건너뜀)
    if(currentUser && (event === 'SIGNED_IN' || event === 'INITIAL_SESSION')){
      await ensureFirstSignupInit(currentUser);
    }
  });

  </script>
</body>
</html>
